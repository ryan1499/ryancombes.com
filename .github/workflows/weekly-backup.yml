name: Weekly Content Backup

on:
  schedule:
    # Run every Sunday at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * 0'
  
  # Allow manual triggering for testing
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  backup-content:
    runs-on: ubuntu-latest
    name: Backup Beehiiv Content
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use a personal access token to allow the action to push back to the repo
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          # Only install what we need for the backup script
          npm install node-fetch
      
      - name: Run backup script
        env:
          BEEHIIV_API_KEY: ${{ secrets.BEEHIIV_API_KEY }}
          BEEHIIV_PUBLICATION_ID: ${{ secrets.BEEHIIV_PUBLICATION_ID }}
        run: |
          echo "ðŸš€ Starting weekly content backup..."
          node scripts/backup-content.js
      
      - name: Verify backup created
        run: |
          if [ -d "content-backup" ]; then
            echo "âœ… Backup directory created successfully"
            echo "ðŸ“Š Backup contains $(find content-backup -name "*.md" | wc -l) markdown files"
            ls -la content-backup/
          else
            echo "âŒ Backup directory not found"
            exit 1
          fi
      
      - name: Commit and push backup
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check current status
          echo "ðŸ“‹ Current git status:"
          git status
          
          # Force add the backup directory (this should override .gitignore)
          echo "ðŸ“ Force adding content-backup directory..."
          git add --force content-backup/
          
          # Check status after force add
          echo "ðŸ“‹ Status after force add:"
          git status
          
          # Check if there are any staged changes
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            echo "âœ… Changes detected, committing..."
            git commit -m "ðŸ”„ Weekly content backup - $(date '+%Y-%m-%d')

ðŸ¤– Automated backup containing:
- $(find content-backup -name "*.md" | wc -l) individual post files
- GPT-optimized archive for ChatGPT
- Backup metadata and documentation

Generated with Claude Code backup system"
            git push
            echo "âœ… Backup committed and pushed successfully"
          fi
      
      - name: Backup summary
        run: |
          echo "## Weekly Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed successfully" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "content-backup/backup-metadata.json" ]; then
            TOTAL_POSTS=$(cat content-backup/backup-metadata.json | grep -o '"total_posts":[0-9]*' | cut -d':' -f2)
            echo "**Posts Backed Up:** $TOTAL_POSTS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Location:** \`content-backup/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "**Next Backup:** Next Sunday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY